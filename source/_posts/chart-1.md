title: iOS报表技术（一）
date: 2015-01-25 20:54:40
tags:
---

报表技术是一个较大的课题，我这里不准备讲的很深入，只是把最近轻卡项目用的那些给稍作分析。
在开发之前我们一般会把已有的功能点，以及可能会产生的功能点列出来，决定技术架构，比如轻卡这个项目体重曲线看起来可能是这样的：

![1](/img/chart-1.png)
![2](/img/chart-2.png)
![3](/img/chart-3.png)

* X轴是时间轴，Y轴是体重轴
* 点与点之间用曲线连接，边界需要自己推算
* 曲线与边界围成的区域需要渐变填充处理
* 曲线数据变化会有动画过渡
* 可以自定义Band--健康体重范围
* 点是可以订制的，也是可以点击的
* 坐标轴可以订制的，也是可以点击的
* 可以在报表上做标注，气泡，图3
* 曲线在不同的Band上可以有不同的表现，比如在正常范围是白色，其它范围是红色
* 曲线是可以拖动的，拖动到边界后可以有一个拖拽加载更多的动画效果 图2

可能会产生的功能点
* 多重曲线，可能会有多重曲线，比如维度体重也叠加到这张报表里
* 双Y坐标轴，或更复杂的坐标系统
* 钻入钻出，即粒度切换，可以从每日体重，切换到每周体重，每月体重

通过这些功能点罗列，可以采用的技术方案也基本上会确定下来

比如
第三方的那些报表库就排除了，无法通过修改扩展满足我们的需求

绘图模型，使用绘画家模式的CoreGraphic技术首先被排除了，可以选择的当然只有CALayer
一方面是可以充分利用GPU性能，使用苹果封装好的CoreAnimation技术，另一个事情就是层模型可以更灵活的实现遮罩效果。

报表内部的数据位置计算也是一个重要的事情，假如是简单的报表当然可以直接在报表组件内部写上这些计算逻辑
但是涉及到坐标轴拉伸，以及多轴系统，这样的方式就非常的Low，也难以操作和维护，所以我们需要实现一个ChartSpace，来进行报表空间和绘图空间的转换，这样的好处是对报表空间的操作都封装到了ChartSpace中，坐标轴，报表图形，以及组件，都可以方便的通过这个对象来获取 “星期一”  “68公斤” 这样的数据在绘图空间的位置，而不需要进行重复的计算，所谓封装，封装的就是变化嘛 ：），另一个好处就是多轴系统可以简单的通过增加 ChartSpace 来实现，轴的拉伸和粒度钻取也变的更加的容易了。


![4](/img/chart-4.jpg)

曲线算法，这里使用了贝塞尔曲线做平滑处理，算出穿越这一系列点的所有控制点，这也是Google的报表库CorePlot采用的算法  https://www.particleincell.com/2012/bezier-splines/ 
但是有个很大的缺陷，就是三个点之间距离比例太大，就会出现非预期的问题（图4），这一问题也通过插值算法进行了解决

今天先到这里啦 ：）




